# üöÄ Guide de D√©ploiement Cloudflare Pages

## üìã Pr√©requis

1. ‚úÖ Compte Cloudflare (gratuit ou payant)
2. ‚úÖ Base de donn√©es PostgreSQL Neon configur√©e
3. ‚úÖ Wrangler CLI install√© globalement
4. ‚úÖ Git repository connect√© √† GitHub

## üîß Configuration Initiale

### 1. Installer Wrangler (si n√©cessaire)
```bash
npm install -g wrangler
# ou
npx wrangler --version
```

### 2. Se connecter √† Cloudflare
```bash
npx wrangler login
```
Cela ouvrira votre navigateur pour l'authentification.

### 3. Configurer les Variables d'Environnement Locales
```bash
# Copier l'exemple
cp .dev.vars.example .dev.vars

# √âditer avec vos vraies valeurs
nano .dev.vars
```

Contenu de `.dev.vars` :
```
DATABASE_URL=postgresql://user:password@ep-xxx.region.aws.neon.tech/dbname?sslmode=require
JWT_SECRET=votre-cle-secrete-jwt-minimum-32-caracteres
```

## üì¶ Build Local

Toujours tester le build localement avant de d√©ployer :

```bash
# Nettoyer et builder
rm -rf dist
npm run build

# V√©rifier le contenu
ls -la dist/
# Vous devriez voir:
# - _worker.js (votre application)
# - _routes.json (configuration des routes)
# - _headers (en-t√™tes de s√©curit√©)
# - static/ (assets statiques)
```

## üåê M√©thode 1 : D√©ploiement via GitHub (Recommand√©)

### Configuration dans le Dashboard Cloudflare

1. **Acc√©dez √† Cloudflare Pages**
   - Allez sur https://dash.cloudflare.com/
   - S√©lectionnez votre compte
   - Cliquez sur "Workers & Pages" > "Create application" > "Pages" > "Connect to Git"

2. **Connectez votre Repository GitHub**
   - Autorisez Cloudflare √† acc√©der √† votre compte GitHub
   - S√©lectionnez le repository : `doriansarry47-creator/planning`
   - Cliquez sur "Begin setup"

3. **Configurez le Build**
   - **Project name** : `webapp` (ou un nom personnalis√©)
   - **Production branch** : `main`
   - **Build command** : `npm run build`
   - **Build output directory** : `dist`
   - **Root directory** : `/` (laisser vide)
   - **Framework preset** : None

4. **Configurer les Variables d'Environnement**
   
   Dans "Environment variables" > "Production" :
   - Cliquez sur "Add variable"
   - Ajoutez les variables suivantes :

   | Variable Name | Value |
   |---------------|-------|
   | `DATABASE_URL` | `postgresql://user:password@host/db?sslmode=require` |
   | `JWT_SECRET` | `votre-cle-secrete-minimum-32-caracteres` |
   | `NODE_VERSION` | `22` |

5. **Sauvegarder et D√©ployer**
   - Cliquez sur "Save and Deploy"
   - Le build et d√©ploiement commenceront automatiquement

### D√©ploiements Automatiques

Une fois configur√©, chaque `git push` sur la branche `main` d√©clenchera automatiquement :
1. ‚úÖ Clone du repository
2. ‚úÖ Installation des d√©pendances (`npm install`)
3. ‚úÖ Build de l'application (`npm run build`)
4. ‚úÖ D√©ploiement sur Cloudflare Pages

## üñ•Ô∏è M√©thode 2 : D√©ploiement Direct avec Wrangler CLI

### Premi√®re fois : Cr√©er le Projet

```bash
# Se connecter √† Cloudflare
npx wrangler login

# Cr√©er le projet Pages
npx wrangler pages project create webapp --production-branch main
```

### Configurer les Secrets

```bash
# DATABASE_URL
npx wrangler pages secret put DATABASE_URL --project-name webapp
# Entrez votre URL de base de donn√©es quand demand√©

# JWT_SECRET
npx wrangler pages secret put JWT_SECRET --project-name webapp
# Entrez votre cl√© secr√®te JWT quand demand√©
```

### Build et D√©ploiement

```bash
# Build
npm run build

# D√©ployer vers production
npx wrangler pages deploy dist --project-name webapp --branch main

# Ou utiliser le script npm
npm run deploy
```

### D√©ploiement vers Preview (Staging)

```bash
# D√©ployer une branche de test
npx wrangler pages deploy dist --project-name webapp --branch preview
```

## üîê Configuration de la Base de Donn√©es

### 1. Initialiser la Base de Donn√©es Neon

```bash
# Se connecter √† votre base de donn√©es Neon
psql "postgresql://user:password@host/database?sslmode=require"

# Ex√©cuter le script d'initialisation
\i init-db.sql

# Ou directement avec psql
psql "postgresql://user:password@host/database?sslmode=require" -f init-db.sql
```

### 2. V√©rifier les Tables

```sql
-- Lister toutes les tables
\dt

-- V√©rifier qu'un admin existe
SELECT * FROM admins LIMIT 1;
```

## üß™ Test du D√©ploiement

### 1. V√©rifier l'URL de Production

Apr√®s le d√©ploiement, Cloudflare vous donnera une URL comme :
```
https://webapp.pages.dev
# ou
https://webapp-xxx.pages.dev
```

### 2. Tester les Endpoints

```bash
# Page d'accueil
curl https://webapp.pages.dev/

# API Health Check
curl https://webapp.pages.dev/api/auth/me

# Test de connexion admin
curl -X POST https://webapp.pages.dev/api/auth/admin/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"admin123"}'
```

### 3. V√©rifier dans le Navigateur

Ouvrez l'URL dans votre navigateur et testez :
- ‚úÖ Page d'accueil s'affiche
- ‚úÖ Inscription patient fonctionne
- ‚úÖ Connexion admin fonctionne
- ‚úÖ Prise de rendez-vous fonctionne

## üêõ D√©pannage

### Probl√®me : Build √©choue sur Cloudflare

**Solution 1 : V√©rifier Node Version**
```bash
# Dans le dashboard Cloudflare, ajouter la variable :
NODE_VERSION=22
```

**Solution 2 : V√©rifier les logs**
- Allez dans "Workers & Pages" > "webapp" > "View build logs"
- Cherchez les erreurs sp√©cifiques

### Probl√®me : 500 Internal Server Error apr√®s d√©ploiement

**Cause probable** : Variables d'environnement manquantes

**Solution** :
1. V√©rifiez que `DATABASE_URL` et `JWT_SECRET` sont configur√©s
2. Red√©ployez apr√®s avoir ajout√© les variables

### Probl√®me : Cannot connect to database

**Causes possibles** :
1. URL de base de donn√©es incorrecte
2. Base de donn√©es non initialis√©e
3. Probl√®me de connexion Neon

**Solutions** :
```bash
# 1. Tester la connexion localement
psql "$DATABASE_URL"

# 2. V√©rifier que sslmode=require est pr√©sent
echo $DATABASE_URL | grep sslmode

# 3. R√©initialiser le secret sur Cloudflare
npx wrangler pages secret put DATABASE_URL --project-name webapp
```

### Probl√®me : JWT token invalide

**Cause** : JWT_SECRET diff√©rent entre local et production

**Solution** :
```bash
# Utiliser le m√™me secret partout
npx wrangler pages secret put JWT_SECRET --project-name webapp
```

## üìä Monitoring et Logs

### Voir les Logs en Temps R√©el

```bash
# Logs de production
npx wrangler pages deployment tail --project-name webapp

# Logs d'un d√©ploiement sp√©cifique
npx wrangler pages deployment tail --project-name webapp --deployment-id <id>
```

### Dashboard Cloudflare

1. Allez sur https://dash.cloudflare.com/
2. "Workers & Pages" > "webapp"
3. Onglets disponibles :
   - **Deployments** : Historique des d√©ploiements
   - **Settings** : Configuration
   - **Functions** : M√©triques de performance
   - **Analytics** : Statistiques d'utilisation

## üîÑ Rollback

Si un d√©ploiement pose probl√®me :

### Via Dashboard
1. Allez dans "Deployments"
2. Trouvez le dernier d√©ploiement qui fonctionnait
3. Cliquez sur "Rollback to this deployment"

### Via CLI
```bash
# Lister les d√©ploiements
npx wrangler pages deployment list --project-name webapp

# Promouvoir un d√©ploiement sp√©cifique en production
npx wrangler pages deployment promote <deployment-id> --project-name webapp
```

## üåç Domaine Personnalis√© (Optionnel)

### Ajouter un Domaine

1. Dans le dashboard : "Custom domains" > "Set up a custom domain"
2. Entrez votre domaine : `example.com`
3. Suivez les instructions pour configurer les DNS

### Configuration DNS

Ajoutez un enregistrement CNAME :
```
CNAME @ webapp.pages.dev
# ou
CNAME www webapp.pages.dev
```

## üìù Checklist de D√©ploiement

Avant chaque d√©ploiement, v√©rifiez :

- [ ] ‚úÖ Les tests locaux passent (`npm run build`)
- [ ] ‚úÖ Les variables d'environnement sont configur√©es
- [ ] ‚úÖ La base de donn√©es est initialis√©e
- [ ] ‚úÖ Le `.gitignore` exclut `.dev.vars` et `node_modules`
- [ ] ‚úÖ Le code est commit√© sur Git
- [ ] ‚úÖ Le build produit `dist/_worker.js`
- [ ] ‚úÖ Les identifiants admin par d√©faut sont chang√©s (production)

## üéâ Apr√®s le D√©ploiement

1. **Tester l'application compl√®te**
   - Inscription patient
   - Connexion patient/admin
   - Prise de rendez-vous
   - Gestion admin

2. **Configurer les alertes**
   - Dans Cloudflare Dashboard > Notifications
   - Activer les alertes pour les erreurs 5xx

3. **Documenter l'URL de production**
   - Mettre √† jour le README.md
   - Partager avec l'√©quipe

## üîó Ressources Utiles

- [Documentation Cloudflare Pages](https://developers.cloudflare.com/pages/)
- [Wrangler CLI Docs](https://developers.cloudflare.com/workers/wrangler/)
- [Hono Framework](https://hono.dev/)
- [Neon Database](https://neon.tech/docs/introduction)

---

**Derni√®re mise √† jour** : 2025-10-29
**Version** : 1.0.0
