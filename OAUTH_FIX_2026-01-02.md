# üîß R√©solution de l'erreur OAuth2 `invalid_client`

**Date**: 2026-01-02  
**Status**: ‚úÖ R√©solu  
**Pull Request**: https://github.com/doriansarry47-creator/planning/pull/54

---

## üìã R√©sum√© du probl√®me

L'application affichait l'erreur suivante dans les logs Vercel :

```
[error] [Vercel TRPC OAuth2] ‚ùå Erreur lors de la r√©cup√©ration des √©v√©nements: invalid_client
[warning] [Vercel TRPC OAuth2] ‚ö†Ô∏è Aucun √©v√©nement r√©cup√©r√© depuis Google Calendar
```

### Cause racine

1. **Redirect URI incorrect** : Le code utilisait `https://localhost` en dur
2. **Mismatch avec Google Cloud Console** : Les credentials √©taient configur√©es pour `http://localhost:3000/oauth2callback`
3. **Anciennes credentials** : Les Client ID/Secret utilis√©s ne correspondaient plus

---

## ‚úÖ Solution impl√©ment√©e

### 1. Mise √† jour du code

**Fichier modifi√©** : `server/services/googleCalendarOAuth2.ts`

```typescript
// AVANT (ligne 107)
this.oauth2Client = new google.auth.OAuth2(
  config.clientId,
  config.clientSecret,
  'https://localhost' // ‚ùå HARDCOD√â
);

// APR√àS
const redirectUri = process.env.GOOGLE_REDIRECT_URI || 'http://localhost:3000/oauth2callback';
this.oauth2Client = new google.auth.OAuth2(
  config.clientId,
  config.clientSecret,
  redirectUri // ‚úÖ DYNAMIQUE depuis env
);
```

### 2. Mise √† jour des variables d'environnement Vercel

Les credentials OAuth2 ont √©t√© mises √† jour avec succ√®s :

```bash
‚úÖ GOOGLE_CLIENT_ID: 603850749287-*****.apps.googleusercontent.com
‚úÖ GOOGLE_CLIENT_SECRET: GOCSPX-*****
‚úÖ GOOGLE_REFRESH_TOKEN: 1//03FMgG83B75Dk...
‚úÖ GOOGLE_REDIRECT_URI: http://localhost:3000/oauth2callback
‚úÖ GOOGLE_CALENDAR_ID: doriansarry47@gmail.com
‚úÖ VITE_GOOGLE_CLIENT_ID: 603850749287-*****.apps.googleusercontent.com
```

Script utilis√© : `./update-vercel-env-new-oauth.sh`

---

## üîê Configuration Google Cloud Console

### √âtapes pour √©viter l'erreur `invalid_client`

1. **Acc√©der √† Google Cloud Console**  
   https://console.cloud.google.com/apis/credentials?project=apaddicto

2. **V√©rifier le Client OAuth 2.0**  
   - Client ID : `603850749287-*****` (voir Vercel env vars)
   - Nom : (v√©rifier dans la console)

3. **V√©rifier les Redirect URIs autoris√©s**  
   Les URIs suivants doivent √™tre configur√©s :
   
   ```
   http://localhost:3000/oauth2callback    ‚Üê Pour d√©veloppement local
   http://localhost:5173/oauth/callback    ‚Üê Pour Vite dev server (optionnel)
   ```
   
   ‚ö†Ô∏è **Pour production Vercel** : Si vous souhaitez utiliser OAuth2 en production, ajoutez :
   ```
   https://votre-domaine-vercel.app/oauth2callback
   ```

4. **V√©rifier les API activ√©es**  
   - ‚úÖ Google Calendar API
   - ‚úÖ Google People API (optionnel)

5. **Port√©e (Scopes) requise**  
   ```
   https://www.googleapis.com/auth/calendar
   https://www.googleapis.com/auth/calendar.events
   ```

---

## üß™ Tests √† effectuer apr√®s d√©ploiement

### 1. V√©rifier les logs Vercel

Apr√®s le d√©ploiement, v√©rifiez que ces lignes apparaissent dans les logs :

```
‚úÖ [GoogleCalendarOAuth2] Service initialis√© avec OAuth 2.0
‚úÖ [GoogleCalendarOAuth2] Access token valide obtenu
‚úÖ [GoogleCalendarOAuth2] X √©v√©nements actifs r√©cup√©r√©s
```

### 2. Test de r√©cup√©ration des disponibilit√©s

Appelez l'endpoint tRPC :

```typescript
// Depuis le client
const availabilities = await trpc.appointments.getAvailabilitiesByDate.query({
  startDate: '2026-01-02',
  endDate: '2026-02-01'
});
```

R√©sultat attendu :
- ‚úÖ Aucune erreur `invalid_client`
- ‚úÖ Les √©v√©nements Google Calendar sont r√©cup√©r√©s
- ‚úÖ Les cr√©neaux "DISPONIBLE" sont list√©s correctement

### 3. Test de cr√©ation de rendez-vous

```typescript
// Depuis le client
const appointment = await trpc.appointments.create.mutate({
  date: '2026-01-05',
  startTime: '10:00',
  endTime: '11:00',
  clientName: 'Test Client',
  clientEmail: 'test@example.com'
});
```

R√©sultat attendu :
- ‚úÖ Rendez-vous cr√©√© en base de donn√©es
- ‚úÖ √âv√©nement cr√©√© dans Google Calendar
- ‚úÖ Email de confirmation envoy√© (si configur√©)

---

## üìä R√©sum√© des modifications

### Code modifi√©
- ‚úÖ `server/services/googleCalendarOAuth2.ts` : Redirect URI dynamique

### Variables d'environnement Vercel
- ‚úÖ 6 variables mises √† jour avec succ√®s
- ‚úÖ Anciennes valeurs supprim√©es
- ‚úÖ Nouvelles valeurs chiffr√©es

### Commit
- **ID** : `2e789cd`
- **Branch** : `genspark_ai_developer`
- **Message** : "fix(oauth): correction redirect_uri dynamique pour OAuth2 Google Calendar"

### Pull Request
- **#54** : https://github.com/doriansarry47-creator/planning/pull/54
- **Status** : Ouvert
- **Base** : main
- **Head** : genspark_ai_developer

---

## üöÄ D√©ploiement

### √âtapes de d√©ploiement

1. **Merger le Pull Request**  
   ```bash
   # Sur GitHub
   gh pr merge 54 --squash
   ```

2. **V√©rifier le d√©ploiement Vercel**  
   - Vercel va automatiquement red√©ployer apr√®s le merge
   - URL de production : https://webapp-frtjapec0-ikips-projects.vercel.app

3. **Tester en production**  
   - Acc√©der √† l'application
   - V√©rifier la page des disponibilit√©s
   - Cr√©er un rendez-vous test

4. **Surveiller les logs**  
   ```bash
   vercel logs --follow
   ```

---

## ‚ö†Ô∏è Notes importantes

### S√©curit√©

- ‚ùå **Ne JAMAIS commiter le fichier `.env`** dans Git
- ‚úÖ Les secrets sont stock√©s uniquement sur Vercel (chiffr√©s)
- ‚úÖ GitHub Secret Scanning a bloqu√© le push du `.env` (protection activ√©e)

### Redirect URI en production

Si vous souhaitez utiliser OAuth2 en production Vercel (et pas seulement le refresh token) :

1. Ajoutez votre domaine Vercel dans Google Cloud Console :
   ```
   https://votre-domaine.vercel.app/oauth2callback
   ```

2. Mettez √† jour `GOOGLE_REDIRECT_URI` sur Vercel :
   ```bash
   vercel env add GOOGLE_REDIRECT_URI production
   # Valeur: https://votre-domaine.vercel.app/oauth2callback
   ```

### Refresh Token

Le refresh token actuel est valide et permet d'obtenir automatiquement des access tokens sans interaction utilisateur. Il n'expire pas sauf si :
- L'utilisateur r√©voque l'acc√®s manuellement
- Le Client ID/Secret est r√©g√©n√©r√©
- 6 mois d'inactivit√© (rare)

---

## üîó Liens utiles

- **Google Cloud Console** : https://console.cloud.google.com/apis/credentials?project=apaddicto
- **Vercel Dashboard** : https://vercel.com/ikips-projects/webapp
- **Repository GitHub** : https://github.com/doriansarry47-creator/planning
- **Pull Request #54** : https://github.com/doriansarry47-creator/planning/pull/54

---

## üìû Support

En cas de probl√®me :

1. V√©rifier les logs Vercel : `vercel logs`
2. V√©rifier les variables d'environnement : `vercel env ls`
3. V√©rifier Google Cloud Console : Credentials et API activ√©es
4. V√©rifier le refresh token : G√©n√©rer un nouveau token si n√©cessaire

---

**‚úÖ Probl√®me r√©solu et document√© le 2026-01-02**
