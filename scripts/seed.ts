import { db } from "../server/db";
import { users, patients, practitioners, timeSlots } from "../shared/schema-sqlite";
import { hashPassword } from "../server/auth";

async function seed() {
  console.log("üå± D√©but de l'initialisation de la base de donn√©es...");

  try {
    // Cr√©er un administrateur par d√©faut
    console.log("üë§ Cr√©ation de l'administrateur par d√©faut...");
    const adminPassword = await hashPassword("admin123");
    
    await db.insert(users).values({
      username: "admin",
      email: "admin@medical.fr",
      password: adminPassword,
      fullName: "Administrateur Principal",
      role: "admin",
    });

    console.log("‚úÖ Administrateur cr√©√©: admin@medical.fr / admin123");

    // Cr√©er des praticiens de test
    console.log("üë®‚Äç‚öïÔ∏è Cr√©ation des praticiens...");
    const practitionersData = [
      {
        firstName: "Dr. Marie",
        lastName: "Dupont",
        specialization: "M√©decine g√©n√©rale",
        email: "marie.dupont@medical.fr",
        phoneNumber: "01 23 45 67 89",
        licenseNumber: "123456789",
        biography: "M√©decin g√©n√©raliste avec 15 ans d'exp√©rience",
        consultationDuration: 30,
      },
      {
        firstName: "Dr. Jean",
        lastName: "Martin", 
        specialization: "Cardiologie",
        email: "jean.martin@medical.fr",
        phoneNumber: "01 23 45 67 90",
        licenseNumber: "987654321",
        biography: "Cardiologue sp√©cialis√© en pr√©vention cardiovasculaire",
        consultationDuration: 45,
      },
      {
        firstName: "Dr. Sophie",
        lastName: "Bernard",
        specialization: "Dermatologie",
        email: "sophie.bernard@medical.fr",
        phoneNumber: "01 23 45 67 91",
        licenseNumber: "456789123",
        biography: "Dermatologue experte en dermatologie esth√©tique",
        consultationDuration: 30,
      }
    ];

    const createdPractitioners = await db.insert(practitioners).values(practitionersData).returning();
    console.log(`‚úÖ ${createdPractitioners.length} praticiens cr√©√©s`);

    // Cr√©er des cr√©neaux horaires pour chaque praticien
    console.log("‚è∞ Cr√©ation des cr√©neaux horaires...");
    const timeSlotsData = [];
    
    for (const practitioner of createdPractitioners) {
      // Cr√©neaux du lundi au vendredi, 9h-17h
      for (let day = 1; day <= 5; day++) {
        // Matin: 9h00 - 12h00
        timeSlotsData.push({
          practitionerId: practitioner.id,
          dayOfWeek: day,
          startTime: "09:00:00",
          endTime: "12:00:00",
        });
        
        // Apr√®s-midi: 14h00 - 17h00
        timeSlotsData.push({
          practitionerId: practitioner.id,
          dayOfWeek: day,
          startTime: "14:00:00",
          endTime: "17:00:00",
        });
      }
    }

    await db.insert(timeSlots).values(timeSlotsData);
    console.log(`‚úÖ ${timeSlotsData.length} cr√©neaux horaires cr√©√©s`);

    // Cr√©er un patient de test
    console.log("üßë‚Äçü§ù‚Äçüßë Cr√©ation d'un patient de test...");
    const patientPassword = await hashPassword("patient123");
    
    await db.insert(patients).values({
      email: "patient@test.fr",
      password: patientPassword,
      firstName: "Pierre",
      lastName: "Durand",
      phoneNumber: "06 12 34 56 78",
      dateOfBirth: "1985-05-15",
      address: "123 Rue de la Sant√©, 75001 Paris",
      emergencyContact: "Marie Durand",
      emergencyPhone: "06 87 65 43 21",
    });

    console.log("‚úÖ Patient de test cr√©√©: patient@test.fr / patient123");

    console.log("\nüéâ Initialisation de la base de donn√©es termin√©e avec succ√®s!");
    console.log("\nüìã Comptes de test cr√©√©s:");
    console.log("üë§ Admin: admin@medical.fr / admin123");
    console.log("üßë‚Äçü§ù‚Äçüßë Patient: patient@test.fr / patient123");
    
  } catch (error) {
    console.error("‚ùå Erreur lors de l'initialisation:", error);
    process.exit(1);
  }
}

// Ex√©cuter le script seulement si appel√© directement
if (import.meta.url.includes(process.argv[1])) {
  seed().then(() => process.exit(0));
}

export default seed;