import { config } from 'dotenv';

// Charger les variables d'environnement depuis .env
config({ path: '.env' });

import { users, patients, practitioners } from '../shared/sqlite-schema';
import Database from 'better-sqlite3';
import { drizzle } from 'drizzle-orm/better-sqlite3';
import { hashPassword } from '../api/_lib/auth';

const sqlite = new Database('./dev.sqlite');
const db = drizzle(sqlite);

async function seed() {
  try {
    console.log('üå± D√©but du seeding...');

    // Cr√©er un admin par d√©faut
    const hashedAdminPassword = await hashPassword('admin123');
    await db.insert(users).values({
      username: 'admin',
      email: 'admin@medplan.fr',
      password: hashedAdminPassword,
      fullName: 'Administrateur Principal',
      role: 'admin',
    }).onConflictDoNothing();

    // Cr√©er le compte admin de Dorian Sarry
    const hashedDorianPassword = await hashPassword('admin123');
    await db.insert(users).values({
      username: 'doriansarry',
      email: 'doriansarry47@gmail.com',
      password: hashedDorianPassword,
      fullName: 'Dorian Sarry',
      role: 'admin',
    }).onConflictDoNothing();

    console.log('‚úÖ Administrateurs cr√©√©s');

    // Cr√©er des patients de test
    const hashedPatientPassword = await hashPassword('patient123');
    await db.insert(patients).values([
      {
        email: 'patient@test.fr',
        password: hashedPatientPassword,
        firstName: 'Marie',
        lastName: 'Sereine',
        phoneNumber: '0123456789',
        dateOfBirth: '1985-06-15',
        address: 'Paris, France',
      },
      {
        email: 'test.patient2@example.com',
        password: hashedPatientPassword,
        firstName: 'Paul',
        lastName: 'Bien√™tre',
        phoneNumber: '0123456788',
        dateOfBirth: '1990-03-20',
        address: 'Lyon, France',
      },
    ]).onConflictDoNothing();

    console.log('‚úÖ Patients de test cr√©√©s');

    // Cr√©er Dorian Sarry comme praticien principal
    await db.insert(practitioners).values([
      {
        firstName: 'Dorian',
        lastName: 'Sarry',
        specialization: 'Th√©rapie sensori-motrice',
        email: 'doriansarry47@gmail.com',
        phoneNumber: 'Sur rendez-vous uniquement',
        licenseNumber: 'TSM001',
        biography: 'Th√©rapeute sp√©cialis√© en stabilisation √©motionnelle et traitement du psycho-traumatisme. Approche holistique alliant th√©rapie sensori-motrice et accompagnement bienveillant.',
        consultationDuration: 60,
      },
    ]).onConflictDoNothing();

    console.log('‚úÖ Praticiens cr√©√©s');
    console.log('üéâ Seeding termin√© avec succ√®s !');

    sqlite.close();
    process.exit(0);
  } catch (error) {
    console.error('‚ùå Erreur pendant le seeding:', error);
    sqlite.close();
    process.exit(1);
  }
}

seed();