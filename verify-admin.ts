import { neon } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';
import { eq } from 'drizzle-orm';
import * as schema from './shared/schema';
import * as dotenv from 'dotenv';
import * as path from 'path';

// Charger les variables d'environnement de production
dotenv.config({ path: path.join(process.cwd(), '.env.production') });

async function verifyAdmin() {
  try {
    const DATABASE_URL = process.env.DATABASE_URL;
    
    if (!DATABASE_URL) {
      console.error('‚ùå DATABASE_URL non d√©fini dans .env.production');
      return;
    }

    console.log('üîç Connexion √† la base de donn√©es...');
    const sql = neon(DATABASE_URL);
    const db = drizzle(sql, { schema });
    
    console.log('üîç Recherche du compte admin dorainsarry@yahoo.fr...');
    const admins = await db.select().from(schema.admins).where(eq(schema.admins.email, 'dorainsarry@yahoo.fr'));
    
    if (admins.length > 0) {
      const admin = admins[0];
      console.log('\n‚úÖ Admin trouv√©!');
      console.log('   ID:', admin.id);
      console.log('   Nom:', admin.name);
      console.log('   Email:', admin.email);
      console.log('   R√¥le:', admin.role);
      console.log('   Permissions:', admin.permissions);
      console.log('   Actif:', admin.isActive);
      console.log('   Tentatives de connexion:', admin.loginAttempts);
      console.log('   Verrouill√© jusqu\'√†:', admin.lockedUntil);
      console.log('   Derni√®re connexion:', admin.lastLogin);
      console.log('   Cr√©√© le:', admin.createdAt);
      
      // V√©rifier si le compte est actif et pas verrouill√©
      if (!admin.isActive) {
        console.log('\n‚ö†Ô∏è  ATTENTION: Le compte est D√âSACTIV√â!');
      }
      
      if (admin.lockedUntil) {
        const now = new Date();
        const lockedUntil = new Date(admin.lockedUntil);
        if (now < lockedUntil) {
          console.log('\n‚ö†Ô∏è  ATTENTION: Le compte est VERROUILL√â jusqu\'√†', lockedUntil);
        } else {
          console.log('\n‚úÖ Le verrouillage a expir√©, le compte sera d√©verrouill√© √† la prochaine connexion.');
        }
      }
      
      // V√©rifier les autres admins
      console.log('\nüîç Recherche de tous les admins...');
      const allAdmins = await db.select().from(schema.admins);
      console.log(`   Total d'admins: ${allAdmins.length}`);
      allAdmins.forEach((a, i) => {
        console.log(`   ${i+1}. ${a.email} - ${a.role} - Actif: ${a.isActive}`);
      });
      
    } else {
      console.log('\n‚ùå Admin dorainsarry@yahoo.fr NON TROUV√â dans la base de donn√©es!');
      console.log('   V√©rification des autres admins...');
      
      const allAdmins = await db.select().from(schema.admins);
      if (allAdmins.length > 0) {
        console.log(`   ${allAdmins.length} admin(s) trouv√©(s):`);
        allAdmins.forEach((a, i) => {
          console.log(`   ${i+1}. ${a.email} - ${a.role}`);
        });
      } else {
        console.log('   Aucun admin dans la base de donn√©es!');
      }
    }
    
    // V√©rifier la structure de la table
    console.log('\nüîç V√©rification de la structure de la table admins...');
    const tableCheck = await sql`
      SELECT column_name, data_type, is_nullable, column_default
      FROM information_schema.columns
      WHERE table_name = 'admins'
      ORDER BY ordinal_position;
    `;
    console.log('   Colonnes de la table admins:');
    tableCheck.forEach((col: any) => {
      console.log(`   - ${col.column_name}: ${col.data_type} ${col.is_nullable === 'NO' ? 'NOT NULL' : ''}`);
    });
    
  } catch (error) {
    console.error('\n‚ùå Erreur:', error);
  }
}

verifyAdmin();
