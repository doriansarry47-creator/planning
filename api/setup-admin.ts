import type { VercelRequest, VercelResponse } from '@vercel/node';
import bcrypt from 'bcryptjs';
import { db, admins } from './_lib/db';
import { eq } from 'drizzle-orm';
import { sendSuccess, sendError } from './_lib/response';

/**
 * Route API temporaire pour cr√©er le compte administrateur
 * ‚ö†Ô∏è IMPORTANT: Cette route doit √™tre supprim√©e ou s√©curis√©e apr√®s utilisation
 * 
 * Pour l'utiliser:
 * GET /api/setup-admin
 */
export default async function handler(req: VercelRequest, res: VercelResponse) {
  // Set CORS headers
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'GET') {
    return sendError(res, 'M√©thode non autoris√©e', 405);
  }

  try {
    console.log('üîß D√©but de la configuration du compte administrateur...');

    const adminEmail = 'doriansarry@yahoo.fr';
    const adminPassword = 'Admin123';
    const adminName = 'Dorian Sarry';

    // V√©rifier si l'admin existe d√©j√†
    const existingAdmins = await db
      .select()
      .from(admins)
      .where(eq(admins.email, adminEmail))
      .limit(1);

    if (existingAdmins.length > 0) {
      console.log('‚ö†Ô∏è Un administrateur avec cet email existe d√©j√†.');
      console.log('üîÑ Mise √† jour du mot de passe...');

      // Hasher le nouveau mot de passe
      const hashedPassword = await bcrypt.hash(adminPassword, 12);

      // Mettre √† jour le mot de passe
      const updatedAdmins = await db
        .update(admins)
        .set({ 
          password: hashedPassword,
          name: adminName,
          updatedAt: new Date()
        })
        .where(eq(admins.email, adminEmail))
        .returning();

      console.log('‚úÖ Mot de passe mis √† jour avec succ√®s!');

      return sendSuccess(res, {
        message: 'Compte administrateur mis √† jour avec succ√®s',
        admin: {
          id: updatedAdmins[0].id,
          email: updatedAdmins[0].email,
          name: updatedAdmins[0].name,
        },
        credentials: {
          email: adminEmail,
          password: '****** (voir documentation)',
        }
      }, 'Compte administrateur mis √† jour');
    } else {
      // Cr√©er le nouveau compte admin
      const hashedPassword = await bcrypt.hash(adminPassword, 12);

      const newAdmins = await db.insert(admins).values({
        name: adminName,
        email: adminEmail,
        password: hashedPassword,
      }).returning();

      console.log('‚úÖ Compte administrateur cr√©√© avec succ√®s!');

      return sendSuccess(res, {
        message: 'Compte administrateur cr√©√© avec succ√®s',
        admin: {
          id: newAdmins[0].id,
          email: newAdmins[0].email,
          name: newAdmins[0].name,
        },
        credentials: {
          email: adminEmail,
          password: '****** (voir documentation)',
        },
        instructions: {
          loginUrl: '/login',
          documentation: 'Consultez ADMIN_SETUP.md pour les instructions compl√®tes',
          security: '‚ö†Ô∏è Changez le mot de passe apr√®s la premi√®re connexion',
          cleanup: '‚ö†Ô∏è Supprimez cette route API (/api/setup-admin.ts) apr√®s utilisation'
        }
      }, 'Compte administrateur cr√©√©', 201);
    }
  } catch (error) {
    console.error('‚ùå Erreur lors de la configuration du compte admin:', error);
    return sendError(res, `Erreur lors de la configuration: ${error instanceof Error ? error.message : 'Erreur inconnue'}`, 500);
  }
}
