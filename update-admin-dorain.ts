import { neon } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';
import { eq } from 'drizzle-orm';
import * as schema from './shared/schema';
import bcrypt from 'bcryptjs';
import * as dotenv from 'dotenv';
import * as path from 'path';

// Charger les variables d'environnement de production
dotenv.config({ path: path.join(process.cwd(), '.env.production') });

async function updateAdminDorain() {
  try {
    const DATABASE_URL = process.env.DATABASE_URL;
    
    if (!DATABASE_URL) {
      console.error('‚ùå DATABASE_URL non d√©fini');
      return;
    }

    console.log('üîç Connexion √† la base de donn√©es...');
    const sql = neon(DATABASE_URL);
    const db = drizzle(sql, { schema });
    
    // V√©rifier si dorainsarry@yahoo.fr existe
    console.log('\nüîç V√©rification du compte dorainsarry@yahoo.fr...');
    const dorainsarryAdmins = await db.select()
      .from(schema.admins)
      .where(eq(schema.admins.email, 'dorainsarry@yahoo.fr'));
    
    if (dorainsarryAdmins.length > 0) {
      console.log('‚úÖ Le compte dorainsarry@yahoo.fr existe d√©j√†');
      console.log('   R√©initialisation du mot de passe...');
      
      const hashedPassword = await bcrypt.hash('admin123', 12);
      
      await db.update(schema.admins)
        .set({
          password: hashedPassword,
          isActive: true,
          loginAttempts: 0,
          lockedUntil: null,
          role: 'super_admin',
          permissions: ['read', 'write', 'delete', 'manage_users', 'manage_settings'],
          name: 'Dorian Sarry',
          updatedAt: new Date()
        })
        .where(eq(schema.admins.email, 'dorainsarry@yahoo.fr'));
      
      console.log('‚úÖ Compte mis √† jour avec succ√®s!');
      console.log('   Email: dorainsarry@yahoo.fr');
      console.log('   Mot de passe: admin123');
      console.log('   R√¥le: super_admin');
      
    } else {
      // Cr√©er le compte s'il n'existe pas
      console.log('‚ö†Ô∏è  Le compte dorainsarry@yahoo.fr n\'existe pas');
      console.log('   V√©rification du compte doriansarry@yahoo.fr...');
      
      const doriansarryAdmins = await db.select()
        .from(schema.admins)
        .where(eq(schema.admins.email, 'doriansarry@yahoo.fr'));
      
      if (doriansarryAdmins.length > 0) {
        console.log('‚úÖ Le compte doriansarry@yahoo.fr existe');
        console.log('   Mise √† jour de l\'email vers dorainsarry@yahoo.fr...');
        
        const hashedPassword = await bcrypt.hash('admin123', 12);
        
        await db.update(schema.admins)
          .set({
            email: 'dorainsarry@yahoo.fr',
            password: hashedPassword,
            isActive: true,
            loginAttempts: 0,
            lockedUntil: null,
            role: 'super_admin',
            permissions: ['read', 'write', 'delete', 'manage_users', 'manage_settings'],
            name: 'Dorian Sarry',
            updatedAt: new Date()
          })
          .where(eq(schema.admins.email, 'doriansarry@yahoo.fr'));
        
        console.log('‚úÖ Compte mis √† jour avec succ√®s!');
        console.log('   Nouvel email: dorainsarry@yahoo.fr');
        console.log('   Mot de passe: admin123');
        
      } else {
        // Cr√©er un nouveau compte
        console.log('   Cr√©ation du compte dorainsarry@yahoo.fr...');
        
        const hashedPassword = await bcrypt.hash('admin123', 12);
        
        await db.insert(schema.admins).values({
          email: 'dorainsarry@yahoo.fr',
          password: hashedPassword,
          name: 'Dorian Sarry',
          role: 'super_admin',
          permissions: ['read', 'write', 'delete', 'manage_users', 'manage_settings'],
          isActive: true,
          loginAttempts: 0
        });
        
        console.log('‚úÖ Compte cr√©√© avec succ√®s!');
        console.log('   Email: dorainsarry@yahoo.fr');
        console.log('   Mot de passe: admin123');
      }
    }
    
    // V√©rification finale
    console.log('\nüîç V√©rification finale...');
    const finalCheck = await db.select()
      .from(schema.admins)
      .where(eq(schema.admins.email, 'dorainsarry@yahoo.fr'));
    
    if (finalCheck.length > 0) {
      const admin = finalCheck[0];
      console.log('‚úÖ Compte v√©rifi√©:');
      console.log('   ID:', admin.id);
      console.log('   Email:', admin.email);
      console.log('   Nom:', admin.name);
      console.log('   R√¥le:', admin.role);
      console.log('   Actif:', admin.isActive);
      console.log('   Permissions:', admin.permissions);
    }
    
  } catch (error) {
    console.error('\n‚ùå Erreur:', error);
  }
}

updateAdminDorain();
