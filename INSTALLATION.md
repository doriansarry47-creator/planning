# Guide d'Installation et Configuration

## üéØ Vue d'ensemble

Cette application est une solution compl√®te de gestion de rendez-vous m√©dicaux optimis√©e pour Cloudflare Pages avec backend Hono et base de donn√©es PostgreSQL Neon.

## üìã Pr√©requis

- Node.js 18+ install√©
- Compte Cloudflare (pour le d√©ploiement)
- Base de donn√©es PostgreSQL (Neon recommand√©)
- Git install√©

## üöÄ Installation Rapide

### 1. Cloner le repository

```bash
git clone https://github.com/doriansarry47-creator/planning.git
cd planning
```

### 2. Installer les d√©pendances

```bash
npm install
```

### 3. Configurer la base de donn√©es PostgreSQL

#### Option A: Base de donn√©es existante (Neon)

Vous avez d√©j√† la connexion PostgreSQL fournie:
```
postgresql://neondb_owner:npg_1zDVUWYjNB4s@ep-young-darkness-abdxzpai-pooler.eu-west-2.aws.neon.tech/neondb?sslmode=require&channel_binding=require
```

#### Option B: Cr√©er une nouvelle base de donn√©es Neon

1. Cr√©er un compte sur [Neon](https://neon.tech)
2. Cr√©er un nouveau projet
3. Copier l'URL de connexion PostgreSQL
4. Remplacer dans `.dev.vars`

### 4. Initialiser la base de donn√©es

Ex√©cutez le script SQL d'initialisation pour cr√©er toutes les tables:

#### M√©thode 1: Via psql

```bash
# Avec l'URL de connexion compl√®te
psql "postgresql://neondb_owner:npg_1zDVUWYjNB4s@ep-young-darkness-abdxzpai-pooler.eu-west-2.aws.neon.tech/neondb?sslmode=require" -f init-db.sql
```

#### M√©thode 2: Via l'interface Neon

1. Se connecter sur [console.neon.tech](https://console.neon.tech)
2. Aller dans votre projet
3. Ouvrir le SQL Editor
4. Copier/coller le contenu de `init-db.sql`
5. Ex√©cuter le script

#### M√©thode 3: Via un client PostgreSQL (DBeaver, pgAdmin)

1. Ouvrir votre client PostgreSQL
2. Cr√©er une nouvelle connexion avec les param√®tres:
   - Host: `ep-young-darkness-abdxzpai-pooler.eu-west-2.aws.neon.tech`
   - Port: `5432`
   - Database: `neondb`
   - User: `neondb_owner`
   - Password: `npg_1zDVUWYjNB4s`
   - SSL: `require`
3. Ouvrir et ex√©cuter `init-db.sql`

### 5. Configurer les variables d'environnement

Cr√©er un fichier `.dev.vars` √† la racine du projet:

```bash
# .dev.vars
DATABASE_URL=postgresql://neondb_owner:npg_1zDVUWYjNB4s@ep-young-darkness-abdxzpai-pooler.eu-west-2.aws.neon.tech/neondb?sslmode=require&channel_binding=require
JWT_SECRET=your-super-secret-jwt-key-minimum-32-characters-long-please
```

**‚ö†Ô∏è Important**: 
- Ne JAMAIS committer `.dev.vars` dans git (d√©j√† dans .gitignore)
- Changer le `JWT_SECRET` en production
- Utiliser un g√©n√©rateur de secrets: `openssl rand -base64 32`

### 6. Tester en local

```bash
# Build l'application
npm run build

# Lancer avec wrangler
npm run dev:sandbox

# Ou avec PM2 (recommand√© pour le sandbox)
pm2 start ecosystem.config.cjs

# Tester
curl http://localhost:3000
```

L'application devrait √™tre accessible sur http://localhost:3000

## üîê Identifiants par d√©faut

Apr√®s l'initialisation de la base de donn√©es, un compte administrateur est cr√©√©:

- **Email**: admin@example.com
- **Mot de passe**: admin123

**‚ö†Ô∏è IMPORTANT**: Changez ce mot de passe imm√©diatement en production !

### Changer le mot de passe admin

Pour g√©n√©rer un nouveau hash de mot de passe:

```javascript
// Node.js
const bcrypt = require('bcryptjs');
const newPassword = 'VotreNouveauMotDePasseSecurise123!';
const hash = bcrypt.hashSync(newPassword, 10);
console.log(hash);
```

Puis mettre √† jour dans la base de donn√©es:

```sql
UPDATE admins 
SET password = 'le-hash-g√©n√©r√©' 
WHERE email = 'admin@example.com';
```

## üåê D√©ploiement sur Cloudflare Pages

### 1. Pr√©requis

- Compte Cloudflare
- Wrangler CLI install√©: `npm install -g wrangler`

### 2. Authentification Cloudflare

```bash
wrangler login
```

### 3. Cr√©er le projet Cloudflare Pages

```bash
npx wrangler pages project create webapp --production-branch main
```

### 4. Configurer les secrets de production

```bash
# Configurer DATABASE_URL
npx wrangler pages secret put DATABASE_URL --project-name webapp
# Coller l'URL PostgreSQL quand demand√©

# Configurer JWT_SECRET
npx wrangler pages secret put JWT_SECRET --project-name webapp
# Coller votre secret JWT quand demand√© (g√©n√©r√© avec openssl rand -base64 32)
```

### 5. D√©ployer

```bash
# Build et d√©ployer
npm run deploy

# Ou manuellement
npm run build
npx wrangler pages deploy dist --project-name webapp
```

### 6. Configuration DNS (optionnel)

Pour utiliser un domaine personnalis√©:

```bash
npx wrangler pages domain add votredomaine.com --project-name webapp
```

## üìä Structure de la Base de Donn√©es

Le script `init-db.sql` cr√©e les tables suivantes:

### Tables principales

1. **admins** - Comptes administrateurs
   - Authentification avec bcrypt
   - Gestion des r√¥les et permissions
   - Protection contre les tentatives de connexion r√©p√©t√©es

2. **patients** - Profils patients
   - Informations personnelles
   - Questionnaire m√©dical d'accueil
   - Pr√©f√©rences de consultation

3. **appointments** - Rendez-vous
   - Lien patient/praticien
   - Statuts: pending, confirmed, cancelled, completed
   - Types: cabinet, visio
   - Notes th√©rapeutiques

4. **availability_slots** - Cr√©neaux de disponibilit√©
   - Configuration des horaires
   - Cr√©neaux r√©currents
   - Dur√©es personnalisables

5. **notes** - Notes de suivi
   - Notes priv√©es du th√©rapeute
   - Historique par patient
   - Date de session

6. **unavailabilities** - Indisponibilit√©s
   - Cong√©s et fermetures
   - P√©riodes personnalis√©es

### Index pour performance

Le script cr√©e automatiquement des index sur:
- Emails (patients, admins)
- IDs de patients dans appointments et notes
- Dates de rendez-vous
- Statuts de rendez-vous

## üîß Maintenance et Op√©rations

### Backup de la base de donn√©es

```bash
# Via pg_dump
pg_dump "postgresql://neondb_owner:npg_1zDVUWYjNB4s@ep-young-darkness-abdxzpai-pooler.eu-west-2.aws.neon.tech/neondb?sslmode=require" > backup_$(date +%Y%m%d).sql
```

### Nettoyage des anciennes donn√©es

```sql
-- Supprimer les rendez-vous annul√©s de plus de 6 mois
DELETE FROM appointments 
WHERE status = 'cancelled' 
AND created_at < NOW() - INTERVAL '6 months';

-- Supprimer les cr√©neaux pass√©s
DELETE FROM availability_slots 
WHERE date < CURRENT_DATE - INTERVAL '1 month' 
AND is_available = true;
```

### Monitoring

```sql
-- Statistiques g√©n√©rales
SELECT 
  (SELECT COUNT(*) FROM patients) as total_patients,
  (SELECT COUNT(*) FROM appointments) as total_appointments,
  (SELECT COUNT(*) FROM appointments WHERE status = 'pending') as pending,
  (SELECT COUNT(*) FROM appointments WHERE status = 'confirmed') as confirmed;

-- Rendez-vous par mois
SELECT 
  DATE_TRUNC('month', date) as month,
  COUNT(*) as total_appointments,
  COUNT(CASE WHEN status = 'confirmed' THEN 1 END) as confirmed,
  COUNT(CASE WHEN status = 'cancelled' THEN 1 END) as cancelled
FROM appointments
GROUP BY DATE_TRUNC('month', date)
ORDER BY month DESC
LIMIT 6;
```

## üêõ D√©pannage

### Probl√®me: L'application ne d√©marre pas

```bash
# V√©rifier les logs PM2
pm2 logs webapp

# Red√©marrer
pm2 restart webapp

# Nettoyer et red√©marrer
pm2 delete webapp
npm run build
pm2 start ecosystem.config.cjs
```

### Probl√®me: Erreur de connexion √† la base de donn√©es

1. V√©rifier que `.dev.vars` existe et contient la bonne `DATABASE_URL`
2. Tester la connexion PostgreSQL:
   ```bash
   psql "postgresql://..." -c "SELECT 1;"
   ```
3. V√©rifier que les tables sont cr√©√©es:
   ```bash
   psql "postgresql://..." -c "\dt"
   ```

### Probl√®me: Erreur JWT

- V√©rifier que `JWT_SECRET` est d√©fini dans `.dev.vars`
- Minimum 32 caract√®res recommand√©
- Reg√©n√©rer avec: `openssl rand -base64 32`

### Probl√®me: Port 3000 d√©j√† utilis√©

```bash
# Nettoyer le port
npm run clean-port

# Ou manuellement
fuser -k 3000/tcp
```

## üìö Ressources

- [Documentation Hono](https://hono.dev/)
- [Documentation Cloudflare Pages](https://developers.cloudflare.com/pages/)
- [Documentation Neon PostgreSQL](https://neon.tech/docs)
- [Documentation Drizzle ORM](https://orm.drizzle.team/)
- [Documentation Wrangler](https://developers.cloudflare.com/workers/wrangler/)

## üÜò Support

Pour toute question ou probl√®me:
1. V√©rifier ce guide d'installation
2. Consulter le README.md
3. V√©rifier les logs: `pm2 logs webapp`
4. Contacter l'administrateur

---

**Derni√®re mise √† jour**: 2025-10-27
